<!DOCTYPE html>
<html lang="en">
<header>
  <h1>US Renewable Electric Power Generation</h1>
  <p>
    This interactive web map visualizes proportional symbols sized by generating capacity (MW).
    Use the layer control to compare Biomass, Geothermal, and Solar facilities across the United States.
    Hover over a symbol to highlight it and click to view plant name and capacity details.
  </p>
</header>


  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body { margin: 0; font-family: system-ui, Arial, sans-serif; }
    header {
      padding: 10px 14px;
      border-bottom: 1px solid #ddd;
      background: #fff;
    }
    header h1 { margin: 0; font-size: 18px; }
    header p { margin: 4px 0 0; font-size: 13px; color: #444; }
    #map { height: calc(100vh - 64px); width: 100%; }

    .leaflet-control-layers label { font-size: 13px; }
    .layer-dot {
      display: inline-block;
      width: 10px; height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
      border: 1px solid #111;
    }
  </style>
</head>

<body>
  <header>
    <h1>US Electric Power Generation</h1>
    <p>Compare Biomass, Geothermal, and Solar plants by capacity (MW). Click a circle for details.</p>
  </header>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Data file (must be in same directory as this HTML file) -->
  <script src="power-plants.js"></script>

  <script>
    // -----------------------------
    // MAP SETUP
    // -----------------------------
    const map = L.map("map").setView([39.5, -98.35], 4);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // -----------------------------
    // Helpers
    // -----------------------------
    function toNumber(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function fmtNumber(x) {
      const n = toNumber(x);
      return n === null ? "N/A" : n.toLocaleString();
    }

    // Step 2: Radius function (tuned for smaller outputs)
    function getRadiusMW(mw) {
      const n = toNumber(mw);
      if (n === null || n <= 0) return 2;
      // Adjust multiplier up/down if needed
      return Math.sqrt(n) * 1.1;
    }

    // -----------------------------
    // DATA: your file defines `var plants = {...}`
    // -----------------------------
    if (typeof plants === "undefined") {
      alert("plants is not defined. Make sure power-plants.js is in the same folder and loaded before this script.");
      throw new Error("plants is not defined");
    }

    // Your data stores fuels inside: feature.properties.fuel_source (an object)
    // Example: fuel_source: { "Solar": 120 }
    function hasFuel(feature, fuelLabel) {
      const fs = feature?.properties?.fuel_source;
      return fs && Object.prototype.hasOwnProperty.call(fs, fuelLabel);
    }

    const colors = {
      Biomass: "red",
      Geothermal: "orange",
      Solar: "gold"
    };

    // -----------------------------
    // Step 3: Build 3 distinct layers
    // (each with its own GeoJSON, filter, pointToLayer, onEachFeature)
    // -----------------------------
    function buildLayer(fuelLabel, color) {
      return L.geoJSON(plants, {
        filter: function(feature) {
          return hasFuel(feature, fuelLabel);
        },

        pointToLayer: function(feature, latlng) {
          const mw = feature.properties?.capacity_mw;
          return L.circleMarker(latlng, {
            radius: getRadiusMW(mw),
            color: "#111",
            weight: 1,
            fillColor: color,
            fillOpacity: 0.65
          });
        },

       onEachFeature: function(feature, layer) {

  const name = feature.properties.plant_name;
  const mw = feature.properties.capacity_mw;

  layer.bindPopup(
    `<b>${name}</b><br>
     Capacity: ${mw.toLocaleString()} MW`
  );

  // Hover highlight
  layer.on("mouseover", function() {
    layer.setStyle({ fillColor: "deepskyblue", fillOpacity: 0.85 });
  });

  layer.on("mouseout", function() {
    layer.setStyle({ fillColor: color, fillOpacity: 0.65 });
  });

}

      });
    }

    // Create and add layers to map
    const biomassLayer = buildLayer("Biomass", colors.Biomass).addTo(map);
    const geothermalLayer = buildLayer("Geothermal", colors.Geothermal).addTo(map);
    const solarLayer = buildLayer("Solar", colors.Solar).addTo(map);

    // -----------------------------
    // Step 4: Layer control (clickable legend) with colored labels
    // -----------------------------
    const overlays = {};
    overlays[`<span class="layer-dot" style="background:${colors.Biomass}"></span>Biomass`] = biomassLayer;
    overlays[`<span class="layer-dot" style="background:${colors.Geothermal}"></span>Geothermal`] = geothermalLayer;
    overlays[`<span class="layer-dot" style="background:${colors.Solar}"></span>Solar`] = solarLayer;

    L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    // Optional: zoom to visible data
    try {
      const group = L.featureGroup([biomassLayer, geothermalLayer, solarLayer]);
      if (group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.1));
    } catch (e) {
      console.warn("fitBounds skipped:", e);
    }

    // Debug sanity check (can delete after)
    console.log("Counts:", {
      Biomass: biomassLayer.getLayers().length,
      Geothermal: geothermalLayer.getLayers().length,
      Solar: solarLayer.getLayers().length
    });
  </script>
</body>
</html>
